<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Pokémon TCG 2.0 (DEBUG MODE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ESTILOS DA V2 - OMITIDOS PARA ENCURTAR A RESPOSTA, MAS ELES ESTÃO AQUI NO CÓDIGO FINAL */
        :root {
            --color-background: #0D1117; --color-surface: #161B22; --color-surface-light: #222831; --color-border: #30363D;
            --color-primary: #f59e0b; --color-primary-glow: rgba(245, 158, 11, 0.5); --color-secondary: #3b82f6;
            --color-secondary-glow: rgba(59, 130, 246, 0.3); --color-text-main: #e6edf3; --color-text-muted: #7d8590;
            --font-primary: 'Poppins', sans-serif; --font-display: 'Press Start 2P', cursive; --border-radius-md: 8px;
            --border-radius-lg: 12px; --transition-speed: 0.3s;
        }
        body { font-family: var(--font-primary); background-color: var(--color-background); color: var(--color-text-main); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cg fill='%23161B22' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M0 0h4v4H0V0zm4 4h4v4H4V4z'/%3E%3C/g%3E%3C/svg%3E"); }
        ::-webkit-scrollbar { width: 10px; } ::-webkit-scrollbar-track { background: var(--color-background); }
        ::-webkit-scrollbar-thumb { background: var(--color-surface-light); border-radius: 10px; border: 2px solid var(--color-background); }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }
        .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "header header" "sidebar main"; gap: 2rem; padding: 2rem; min-height: 100vh; }
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; grid-template-areas: "header" "sidebar" "main"; padding: 1rem; gap: 1rem; } }
        .main-header { grid-area: header; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
        .main-header h1 { font-family: var(--font-display); font-size: 1.5rem; color: var(--color-primary); text-shadow: 0 0 10px var(--color-primary-glow); }
        .main-header .user-actions button { font-family: var(--font-primary); font-weight: 600; padding: 0.6rem 1.2rem; border: none; border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) ease; }
        .main-header .login-btn { background-color: var(--color-primary); color: var(--color-background); }
        .main-header .login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px var(--color-primary-glow); }
        .main-header .logout-btn { background-color: #be123c; color: white; }
        .main-header .logout-btn:hover { background-color: #e11d48; }
        #user-email-display { font-weight: 600; } #profile-button { font-size: 0.8rem; color: var(--color-primary); }
        #profile-button:hover { text-decoration: underline; }
        .sidebar { grid-area: sidebar; background-color: var(--color-surface); border-radius: var(--border-radius-lg); padding: 1.5rem; border: 1px solid var(--color-border); height: fit-content; }
        .sidebar-section { padding-bottom: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
        .sidebar-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .sidebar h2 { font-family: var(--font-display); font-size: 1rem; margin-bottom: 1.5rem; color: var(--color-text-main); }
        #collection-value { color: var(--color-primary); font-weight: 700; font-size: 1.75rem; }
        #collection-count, #unique-collection-count { font-weight: 600; }
        .progress-bar-container { height: 22px; background-color: #111827; border-radius: 8px; border: 2px solid var(--color-border); margin-top: 0.5rem; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease-in-out, background 0.5s ease-in-out; }
        .progress-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .sidebar-controls label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--color-text-muted); }
        .sidebar-controls select, .sidebar-controls button { width: 100%; background-color: var(--color-surface-light); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.75rem; color: var(--color-text-main); font-weight: 500; }
        .sidebar-controls select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-glow); }
        .share-btn { background-color: #166534; color: white; font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed) ease; }
        .share-btn:hover { background-color: #15803d; }
        .main-content { grid-area: main; overflow: hidden; }
        .search-container { background-color: var(--color-surface); padding: 1.5rem; border-radius: var(--border-radius-lg); border: 1px solid var(--color-border); margin-bottom: 2rem; }
        .search-toggle { display: flex; background-color: var(--color-surface-light); border-radius: var(--border-radius-md); padding: 0.3rem; margin-bottom: 1rem; }
        .search-toggle label { flex: 1; text-align: center; padding: 0.6rem; border-radius: 6px; color: var(--color-text-muted); font-weight: 600; cursor: pointer; position: relative; transition: color var(--transition-speed) ease; }
        .search-toggle input[type="radio"] { display: none; }
        .search-toggle input[type="radio"]:checked + label { background-color: var(--color-background); color: var(--color-text-main); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #search-input, #set-select { width: 100%; background-color: var(--color-surface-light); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.75rem 1rem; color: var(--color-text-main); font-size: 1rem; transition: all var(--transition-speed) ease; }
        #search-input:focus, #set-select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-glow); }
        #search-button { padding: 0.75rem 2rem; border: none; border-radius: var(--border-radius-md); background-color: var(--color-primary); color: var(--color-background); font-weight: 700; cursor: pointer; transition: all var(--transition-speed) ease; }
        #search-button:hover { transform: translateY(-2px); box-shadow: 0 4px 20px var(--color-primary-glow); }
        #search-results, #my-collection { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; max-height: 80vh; overflow-y: auto; padding: 0 0.5rem 2rem 0; }
        #my-collection { max-height: calc(100vh - 200px); }
        .card-item, .collection-card { background-color: var(--color-surface-light); border-radius: var(--border-radius-lg); border: 1px solid transparent; text-align: center; padding: 0.75rem; position: relative; transition: all var(--transition-speed) ease; transform-style: preserve-3d; }
        .card-item:hover { transform: translateY(-5px) scale(1.03); border-color: var(--color-secondary); }
        .collection-card { perspective: 1000px; }
        .collection-card:hover { z-index: 10; transform: translateY(-10px) scale(1.05); }
        .collection-card .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .collection-card:hover .card-inner { transform: rotateY(5deg) rotateX(10deg); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }
        .collection-card img { border-radius: var(--border-radius-md); width: 100%; aspect-ratio: 5/7; object-fit: cover; }
        .collection-card .card-name { font-weight: 600; margin-top: 0.75rem; font-size: 0.9rem; }
        .collection-card .card-set { font-size: 0.75rem; color: var(--color-text-muted); display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 0.25rem; }
        .collection-card .card-set img { width: 16px; height: 16px; }
        .collection-card .card-controls { padding: 0.75rem 0 0.25rem; margin-top: 0.75rem; border-top: 1px solid var(--color-border); }
        .control-group { display: flex; justify-content: space-between; align-items: center; }
        .control-group span { font-size: 1.25rem; font-weight: 700; }
        .control-group .label { font-size: 0.8rem; font-weight: 500; color: var(--color-text-muted); }
        .control-group .label.trade { color: var(--color-primary); }
        .control-group button { background: none; border: 1px solid var(--color-border); color: var(--color-text-main); width: 28px; height: 28px; border-radius: 50%; font-size: 1.2rem; line-height: 1; cursor: pointer; transition: all var(--transition-speed) ease; }
        .control-group button:hover { background-color: var(--color-primary); color: var(--color-background); border-color: var(--color-primary); }
        .loader { border: 4px solid var(--color-border); border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--color-surface); padding: 2rem; border-radius: var(--border-radius-lg); width: 90%; max-width: 800px; max-height: 85vh; box-shadow: 0 10px 35px rgba(0,0,0,0.4); border: 1px solid var(--color-border); }
        .modal-content h2 { font-family: var(--font-display); }
        .modal-content input, .modal-content select { background-color: var(--color-surface-light); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.75rem; }
        .modal-content input:focus, .modal-content select:focus { outline: none; border-color: var(--color-primary); }
    </style>
</head>
<body>

    <div class="dashboard-grid">
        <header class="main-header">
            <div>
                <h1>TCG Manager 2.0</h1>
            </div>
            <div id="logged-in-header" class="hidden flex items-center gap-4 user-actions">
                <div class="text-right">
                    <p id="user-email-display" class="text-sm font-semibold"></p>
                    <button id="profile-button" class="text-xs">Editar Perfil</button>
                </div>
                <button id="logout-button" class="logout-btn">Sair</button>
            </div>
            <div id="logged-out-header" class="user-actions">
                <button id="open-auth-modal-btn" class="login-btn">Login / Criar Conta</button>
            </div>
        </header>

        <aside class="sidebar">
            <div class="sidebar-section">
                <h2>Minha Coleção</h2>
                <div class="space-y-2">
                    <p class="text-sm text-gray-400">Valor Estimado</p>
                    <p>R$ <span id="collection-value">0,00</span></p>
                    <p class="text-sm text-gray-400 pt-2"><span id="collection-count">0</span> Cartas (<span id="unique-collection-count">0</span> Únicas)</p>
                </div>
            </div>

            <div id="overall-progress-section" class="sidebar-section hidden">
                <h3 class="text-base font-bold mb-2">Progresso da Pokédex</h3>
                <div class="progress-bar-container">
                    <div id="pokedex-progress-fill" class="progress-bar-fill"></div>
                    <span id="pokedex-progress-text" class="progress-bar-text">0/1025</span>
                </div>
            </div>

            <div class="sidebar-section sidebar-controls space-y-4">
                <div>
                    <label for="group-by-select">Organizar por:</label>
                    <select id="group-by-select">
                        <option value="edition">Edição</option>
                        <option value="pokedex">Pokédex</option>
                        <option value="value">Valor</option>
                    </select>
                </div>
                <div>
                    <button id="share-collection-btn" class="hidden share-btn">
                        Compartilhar Coleção
                    </button>
                </div>
            </div>

             <div id="collection-prompt" class="text-center p-4 bg-gray-800/50 rounded-lg">
                <p class="text-sm text-gray-400">Faça login para ver e gerir a sua coleção.</p>
            </div>
        </aside>

        <main class="main-content">
            <div class="search-container">
                <div class="search-toggle">
                    <input type="radio" name="search-type" value="card" id="search-type-card" class="w-4 h-4" checked>
                    <label for="search-type-card">Buscar por Carta</label>
                    <input type="radio" name="search-type" value="set" id="search-type-set" class="w-4 h-4">
                    <label for="search-type-set">Buscar por Edição</label>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div id="search-input-container" class="w-full">
                        <input type="text" id="search-input" placeholder="Nome da carta ou 058/165">
                    </div>
                    <div id="set-select-container" class="w-full hidden">
                         <select id="set-select">
                            <option>Carregando edições...</option>
                         </select>
                    </div>
                    <button id="search-button">Buscar</button>
                </div>
            </div>

            <div id="loader" class="loader mx-auto hidden"></div>
            <div id="search-results"></div>
            <div id="collection-loader" class="loader mx-auto hidden"></div>
            <div id="my-collection"></div>
        </main>
    </div>

    <div id="auth-modal" class="modal-overlay"><div class="modal-content" style="max-width: 450px;"><div class="flex justify-between items-center mb-6"><h2 class="text-xl">Acesso</h2><button id="auth-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white transition-colors">&times;</button></div><div id="login-tab"><h3 class="text-lg text-center mb-4">Login com E-mail</h3><form id="login-form" class="space-y-4" style="font-family: 'Poppins', sans-serif;"><input class="w-full" name="email" type="email" placeholder="Email" required><input class="w-full" name="password" type="password" placeholder="Senha" required><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Entrar</button></form><p class="text-center text-sm text-gray-400 mt-4">Não tem conta? <button id="show-register-btn" class="text-yellow-400 hover:underline">Crie uma.</button></p></div><div id="register-tab" class="hidden"><h3 class="text-lg text-center mb-4">Criar Conta</h3><form id="register-form" class="space-y-4" style="font-family: 'Poppins', sans-serif;"><input class="w-full" name="email" type="email" placeholder="Email" required><input class="w-full" name="password" type="password" placeholder="Senha (mín. 6 caracteres)" required><input class="w-full" name="confirm-password" type="password" placeholder="Confirmar Senha" required><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Criar Conta</button></form><p class="text-center text-sm text-gray-400 mt-4">Já tem conta? <button id="show-login-btn" class="text-yellow-400 hover:underline">Faça login.</button></p></div></div></div>
    <div id="add-card-modal" class="modal-overlay"><div class="modal-content flex flex-col" style="max-width: 48rem;"><div class="flex justify-between items-center mb-6 flex-shrink-0"><h2 class="text-xl">Adicionar à Coleção</h2><button id="add-card-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white transition-colors">&times;</button></div><div class="flex flex-col sm:flex-row gap-8 overflow-y-auto pr-4"><img id="modal-card-image" src="" alt="Imagem da carta" class="w-full sm:w-56 flex-shrink-0 rounded-lg aspect-[5/7] object-cover self-start"><form id="add-card-form" class="flex-grow flex flex-col" style="font-family: 'Poppins', sans-serif;"><h3 id="modal-card-name" class="text-2xl font-bold"></h3><div id="modal-card-set-info" class="text-sm text-gray-400 mb-6"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><label class="block"><span class="block mb-1 font-semibold text-gray-300">Qualidade:</span><select name="quality" id="quality" class="w-full"><option value="Nova">Nova (Mint/NM)</option><option value="Pouco Usada">Pouco Usada (LP)</option><option value="Usada">Usada (Played)</option></select></label><label class="block"><span class="block mb-1 font-semibold text-gray-300">Acabamento:</span><select name="finish" id="finish" class="w-full"></select></label><label class="block"><span class="block mb-1 font-semibold text-gray-300">Idioma:</span><select name="language" id="language" class="w-full"><option value="BR">Português (BR)</option><option value="EN">Inglês (EN)</option><option value="JP">Japonês (JP)</option></select></label><label class="block"><span class="block mb-1 font-semibold text-gray-300">Quantidade:</span><input type="number" name="quantity" id="quantity" value="1" min="1" class="w-full"></label></div><div class="mt-auto"><p id="modal-price-display" class="text-xl font-bold text-yellow-400 my-4 text-center sm:text-right">Valor: R$ 0,00</p><button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-colors">Confirmar</button></div></form></div></div></div>
    <div id="details-modal" class="modal-overlay"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl">Detalhes da Carta</h2><button id="details-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white transition-colors">&times;</button></div><div class="flex flex-col sm:flex-row gap-6"><img id="details-card-image" src="" alt="Imagem da carta" class="w-full sm:w-1/3 rounded-lg"><div class="flex-grow" style="font-family: 'Poppins', sans-serif;"><h3 id="details-card-name" class="text-2xl font-bold mb-2"></h3><div id="details-card-set-info" class="mb-4"></div><div class="mb-4"><p class="font-semibold">Qualidade:</p><p id="details-card-quality" class="text-lg text-blue-300"></p></div><div class="mb-4"><p class="font-semibold">Acabamento:</p><p id="details-card-finish" class="text-lg text-cyan-300"></p></div><div><p class="font-semibold">Valor Registado:</p><p id="details-card-price" class="text-lg font-bold text-yellow-400"></p><p class="text-xs text-gray-400 mt-2 italic">*Valor em R$ é uma estimativa.</p></div></div></div></div></div>
    <div id="profile-modal" class="modal-overlay"><div class="modal-content" style="max-width: 500px;"><div class="flex justify-between items-center mb-6"><h2 class="text-xl">Gerenciar Perfil</h2><button id="profile-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white">&times;</button></div><form id="profile-form" style="font-family: 'Poppins', sans-serif;"><div class="mb-4"><label for="profile-name" class="block font-semibold mb-1">Nome / Nickname</label><input type="text" id="profile-name" class="w-full" required></div><div class="mb-4"><label for="profile-social" class="block font-semibold mb-1">Rede Social (opcional)</label><input type="text" id="profile-social" placeholder="instagram.com/seu_perfil" class="w-full"></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Salvar Alterações</button><p id="profile-feedback" class="text-center mt-4 h-5"></p></form></div></div>
    <div id="share-modal" class="modal-overlay"><div class="modal-content" style="max-width: 500px; font-family: 'Poppins', sans-serif;"><div class="flex justify-between items-center mb-4"><h2 class="text-xl" style="font-family: 'Press Start 2P', cursive;">Compartilhar Coleção</h2><button id="share-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white">&times;</button></div><p class="text-gray-400 mb-6">Use o link abaixo para compartilhar uma visão pública da sua coleção com outros treinadores!</p><div class="mb-6"><label for="public-toggle" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="public-toggle" class="sr-only"><div class="block bg-gray-600 w-14 h-8 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition" style="transform: translateX(0); background-color: white;"></div></div><div id="public-status-text" class="ml-3 text-white font-medium">Minha coleção é Privada</div></label></div><div><div class="mb-4"><label for="shareable-link-all" class="block text-sm font-medium text-gray-300 mb-1">Link para Exibição:</label><div class="flex"><input type="text" id="shareable-link-all" readonly class="w-full"><button data-target="shareable-link-all" class="copy-link-btn bg-blue-500 text-white font-bold px-4 rounded-r-lg hover:bg-blue-600">Copiar</button></div></div><div><label for="shareable-link-trade" class="block text-sm font-medium text-gray-300 mb-1">Link para Troca/Venda:</label><div class="flex"><input type="text" id="shareable-link-trade" readonly class="w-full"><button data-target="shareable-link-trade" class="copy-link-btn bg-yellow-500 text-gray-900 font-bold px-4 rounded-r-lg hover:bg-yellow-600">Copiar</button></div></div><p id="copy-feedback" class="text-green-400 text-sm text-center mt-3 h-4"></p></div></div></div>
    <div id="toast-notification" class="fixed bottom-8 right-8 bg-green-600 text-white py-3 px-5 rounded-lg shadow-xl transform translate-y-24 opacity-0 transition-all duration-500 ease-in-out z-[100]" style="font-family: 'Poppins', sans-serif;"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- INÍCIO DO SCRIPT DE DEPURAÇÃO ---

        document.addEventListener('DOMContentLoaded', async () => {
            const authModal = document.getElementById('auth-modal');
            const authModalCloseBtn = document.getElementById('auth-modal-close-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loggedOutHeader = document.getElementById('logged-out-header');
            const loggedInHeader = document.getElementById('logged-in-header');
            const openAuthModalBtn = document.getElementById('open-auth-modal-btn');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutButton = document.getElementById('logout-button');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');
            const searchInputContainer = document.getElementById('search-input-container');
            const setSelectContainer = document.getElementById('set-select-container');
            const setSelect = document.getElementById('set-select');
            const searchResultsContainer = document.getElementById('search-results');
            const myCollectionContainer = document.getElementById('my-collection');
            const loader = document.getElementById('loader');
            const collectionLoader = document.getElementById('collection-loader');
            const collectionCount = document.getElementById('collection-count');
            const uniqueCollectionCount = document.getElementById('unique-collection-count');
            const collectionValue = document.getElementById('collection-value');
            const groupBySelect = document.getElementById('group-by-select');
            const collectionPrompt = document.getElementById('collection-prompt');
            const addCardModal = document.getElementById('add-card-modal');
            const addCardForm = document.getElementById('add-card-form');
            const addCardModalCloseBtn = document.getElementById('add-card-modal-close-btn');
            const detailsModal = document.getElementById('details-modal');
            const detailsModalCloseBtn = document.getElementById('details-modal-close-btn');
            const shareCollectionBtn = document.getElementById('share-collection-btn');
            const shareModal = document.getElementById('share-modal');
            const shareModalCloseBtn = document.getElementById('share-modal-close-btn');
            const publicToggle = document.getElementById('public-toggle');
            const profileModal = document.getElementById('profile-modal');
            const profileModalCloseBtn = document.getElementById('profile-modal-close-btn');
            const profileButton = document.getElementById('profile-button');
            const profileForm = document.getElementById('profile-form');
            const profileNameInput = document.getElementById('profile-name');
            const toastNotification = document.getElementById('toast-notification');
            
            let currentUserId = null;
            let searchCache = new Map();
            let collectionData = new Map();
            let collectionUnsubscribe = null;
            let usdToBrlRate = 5.3;
            let db, auth;

            console.log('DEBUG: Script iniciado.');

            const profileButtonClickHandler = async () => { /* Lógica do perfil... */ };
            profileButton.addEventListener('click', profileButtonClickHandler);
            profileModalCloseBtn.addEventListener('click', () => profileModal.style.display = 'none');
            profileForm.addEventListener('submit', async (e) => { /* Lógica do form de perfil... */ });
            
            const getFinishDisplayName = (key) => {
                const names = { normal: 'Normal', holofoil: 'Holo', reverseHolofoil: 'Reverse Holo', '1stEditionHolofoil': '1ª Edição Holo', '1stEditionNormal': '1ª Edição Normal', unlimitedHolofoil: 'Unlimited Holo' };
                return names[key] || key;
            };

            const fetchExchangeRate = async () => { /* Lógica de busca de câmbio... */ };
            
            const fillSetDropdown = (sets) => { /* Lógica de popular dropdown... */ };

            const populateSetDropdown = async () => { /* Lógica de buscar sets... */ };

            const toggleSearchMode = () => {
                const searchType = document.querySelector('input[name="search-type"]:checked').value;
                searchInputContainer.classList.toggle('hidden', searchType !== 'card');
                setSelectContainer.classList.toggle('hidden', searchType !== 'set');
            };
            
            searchTypeRadios.forEach(radio => radio.addEventListener('change', toggleSearchMode));

            const searchCards = async () => { /* Lógica de busca de cartas... */ };

            const displaySearchResults = (cards) => { /* Lógica de exibir resultados... */ };
            
            const openAddCardModal = (cardId) => { /* Lógica de abrir modal de add... */ };

            const updatePriceDisplay = () => { /* Lógica de atualizar preço no modal... */ };
            
            const handleAddFormSubmit = async (e) => {
                e.preventDefault();
                const cardId = addCardForm.dataset.cardId, card = searchCache.get(cardId), quality = addCardForm.quality.value, finishKey = addCardForm.finish.value;
                const cardData = {
                    id: card.id, name: card.name, image: card.images.small,
                    set: { id: card.set.id, name: card.set.name, series: card.set.series, printedTotal: card.set.printedTotal, total: card.set.total, releaseDate: card.set.releaseDate, images: { symbol: card.set.images.symbol, logo: card.set.images.logo } },
                    number: card.number, quality: quality, finish: getFinishDisplayName(finishKey), 
                    acquiredPrice: parseFloat(String(addCardForm.dataset.currentPrice).replace(',', '.')),
                    pokedexNumber: card.nationalPokedexNumbers?.[0] || null, language: document.getElementById('language').value
                };
                if (!currentUserId) return;
                const docId = `${cardData.id}-${cardData.quality}-${cardData.finish}-${cardData.language}`;
                const cardRef = doc(db, `users/${currentUserId}/tcg-collection`, docId), docSnap = await getDoc(cardRef);
                const quantityToAdd = parseInt(addCardForm.quantity.value, 10) || 1;
                if (docSnap.exists()) await updateDoc(cardRef, { quantityTotal: increment(quantityToAdd) });
                else await setDoc(cardRef, { ...cardData, quantityTotal: quantityToAdd, quantityForTrade: 0 });
                addCardModal.style.display = 'none';
                toastNotification.innerHTML = `<strong>${card.name}</strong> adicionado à coleção!`;
                toastNotification.classList.remove('opacity-0', 'translate-y-24');
                setTimeout(() => toastNotification.classList.add('opacity-0', 'translate-y-24'), 3000);
            };
            
            const openDetailsModal = (docId) => { /* Lógica de abrir modal de detalhes... */ };

            const handleCollectionClick = async (e) => { /* Lógica de cliques na coleção... */ };
            
            const loadMyCollection = () => {
                console.log('DEBUG: loadMyCollection chamada.');
                if (!currentUserId) {
                    console.log('DEBUG: Abortando loadMyCollection, sem currentUserId.');
                    return;
                }
                collectionLoader.classList.remove('hidden');
                collectionPrompt.classList.add('hidden');
                document.getElementById('overall-progress-section').classList.remove('hidden');
                
                const collectionPath = `users/${currentUserId}/tcg-collection`;
                console.log(`DEBUG: Tentando carregar coleção do caminho: ${collectionPath}`);
                
                const collectionRef = collection(db, collectionPath);
                
                collectionUnsubscribe = onSnapshot(collectionRef, (snapshot) => {
                    console.log('DEBUG: onSnapshot ativado! Recebeu uma atualização do Firestore.');
                    console.log(`DEBUG: Snapshot contém ${snapshot.size} documento(s).`);

                    if (snapshot.empty) {
                        console.log('DEBUG: O snapshot está vazio. A coleção pode não existir ou não ter cartas.');
                    }

                    collectionLoader.classList.add('hidden');
                    collectionData.clear();
                    
                    let docCounter = 0;
                    snapshot.docs.forEach(doc => {
                        if(docCounter === 0) {
                            console.log('DEBUG: Dados do primeiro documento recebido:', doc.data());
                        }
                        docCounter++;
                        const card = { ...doc.data(), docId: doc.id };
                        if (card.quantityForTrade === undefined) card.quantityForTrade = 0;
                        collectionData.set(doc.id, card);
                    });
                    console.log(`DEBUG: 'collectionData' (Map) populado com ${collectionData.size} cartas.`);
                    renderCollection();
                }, (error) => {
                    console.error("DEBUG: ERRO no onSnapshot:", error);
                    alert("Ocorreu um erro ao carregar sua coleção. Verifique o console (F12) para mais detalhes.");
                });
            };

            const renderCollection = () => {
                console.log('DEBUG: renderCollection chamada.');
                if (!collectionData) {
                    console.log('DEBUG: Abortando renderCollection, collectionData não existe.');
                    return;
                }

                let totalCards = 0, totalValue = 0;
                const allCards = Array.from(collectionData.values());
                
                console.log(`DEBUG: Calculando totais para ${allCards.length} tipos de cartas.`);

                allCards.forEach((card, index) => {
                    const price = card.acquiredPrice;
                    const quantity = card.quantityTotal;

                    if (index === 0) {
                        console.log(`DEBUG: Processando card 1: Price=${price} (tipo: ${typeof price}), Quantity=${quantity} (tipo: ${typeof quantity})`);
                    }
                    
                    if (quantity && !isNaN(quantity)) {
                         totalCards += quantity;
                    } else {
                         console.warn(`DEBUG: 'quantityTotal' inválido para a carta ${card.name}. Valor:`, quantity);
                    }

                    if (price && !isNaN(price) && quantity && !isNaN(quantity)) {
                        totalValue += price * quantity;
                    } else {
                         console.warn(`DEBUG: 'acquiredPrice' inválido para a carta ${card.name}. Valor:`, price);
                    }
                });

                console.log(`DEBUG: Fim do cálculo. Total de Cartas: ${totalCards}, Valor Total: ${totalValue}`);

                collectionCount.textContent = totalCards;
                uniqueCollectionCount.textContent = collectionData.size;
                collectionValue.textContent = totalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                myCollectionContainer.innerHTML = '';
                if (collectionData.size === 0) {
                    myCollectionContainer.innerHTML = `<p class="text-center text-gray-400 col-span-full py-10">Sua coleção está vazia.</p>`;
                    return;
                }
                
                const groupBy = groupBySelect.value;
                if (groupBy === 'pokedex') allCards.sort((a, b) => (a.pokedexNumber || 9999) - (b.pokedexNumber || 9999));
                else if (groupBy === 'value') allCards.sort((a, b) => (b.acquiredPrice || 0) - (a.acquiredPrice || 0));
                
                allCards.forEach(card => myCollectionContainer.appendChild(createCardElement(card)));
            };

            const createCardElement = (card) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'collection-card cursor-pointer';
                cardElement.dataset.id = card.docId;
                const cardPrice = (card.acquiredPrice || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const cardHTML = `
                    <div class="card-inner">
                        <img src="${card.image}" alt="${card.name}">
                        <p class="card-name">${card.name}</p>
                        <div class="card-set">
                            <img src="${card.set.images.symbol}" alt="Set Symbol">
                            <span>#${String(card.number).padStart(3, '0')}</span>
                        </div>
                        <p class="font-bold text-yellow-400 text-sm mt-2">${cardPrice}</p>
                        <div class="card-controls">
                            <div class="control-group">
                                <div class="text-left">
                                    <div class="label">Total</div>
                                    <div class="flex items-center gap-2">
                                        <button data-action="total-minus" data-id="${card.docId}">-</button>
                                        <span>${card.quantityTotal}</span>
                                        <button data-action="total-plus" data-id="${card.docId}">+</button>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="label trade">P/ Troca</div>
                                    <div class="flex items-center gap-2">
                                        <button data-action="trade-minus" data-id="${card.docId}">-</button>
                                        <span>${card.quantityForTrade || 0}</span>
                                        <button data-action="trade-plus" data-id="${card.docId}">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                cardElement.innerHTML = cardHTML;
                return cardElement;
            };

            const updateShareUI = (isPublic) => { /* Lógica de UI de compartilhar... */ };
            
            try {
                await Promise.all([fetchExchangeRate(), populateSetDropdown()]);
            } catch (error) { console.error("Erro nas chamadas iniciais:", error); }
            
            toggleSearchMode();
            addCardForm.addEventListener('submit', handleAddFormSubmit);
            myCollectionContainer.addEventListener('click', handleCollectionClick);
            groupBySelect.addEventListener('change', renderCollection);
            
            const firebaseConfig = { apiKey: "AIzaSyDZTXYGAHje-ZFnnhoiNwEUkNAmq63tY68", authDomain: "pokemtcgcard.firebaseapp.com", projectId: "pokemtcgcard", storageBucket: "pokemtcgcard.appspot.com", messagingSenderId: "1056735056128", appId: "1:1056735056128:web:d47f0474b925246c0de3e5", measurementId: "G-JBPHZ0EQWC" };
            console.log('DEBUG: Configuração do Firebase:', firebaseConfig);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                console.log('DEBUG: onAuthStateChanged ativado.');
                if (collectionUnsubscribe) {
                    console.log('DEBUG: Cancelando inscrição do onSnapshot anterior.');
                    collectionUnsubscribe();
                }

                currentUserId = user?.uid || null;
                console.log(`DEBUG: UID do usuário atual: ${currentUserId}`);

                loggedInHeader.classList.toggle('hidden', !user);
                loggedOutHeader.classList.toggle('hidden', !!user);
                collectionPrompt.classList.toggle('hidden', !!user);
                document.getElementById('overall-progress-section').classList.toggle('hidden', !user);
                shareCollectionBtn.classList.toggle('hidden', !user);

                if (user) {
                    userEmailDisplay.textContent = user.displayName || user.email;
                    loadMyCollection();
                } else {
                    console.log('DEBUG: Usuário deslogado. Limpando a coleção.');
                    myCollectionContainer.innerHTML = '';
                    collectionData.clear();
                    collectionCount.textContent = '0';
                    uniqueCollectionCount.textContent = '0';
                    collectionValue.textContent = '0,00';
                }
            });
        });
    </script>
</body>
</html>
