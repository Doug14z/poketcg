<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Pokémon TCG 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /*
        ===============================================
         SISTEMA DE DESIGN E ESTILOS - TCG MANAGER 2.0
        ===============================================
        */
        :root {
            --color-background: #0D1117; /* GitHub Dark Dimmed */
            --color-surface: #161B22;    /* Surface color */
            --color-surface-light: #222831;
            --color-border: #30363D;
            --color-primary: #f59e0b;     /* Âmbar/Dourado */
            --color-primary-glow: rgba(245, 158, 11, 0.5);
            --color-secondary: #3b82f6;   /* Azul */
            --color-secondary-glow: rgba(59, 130, 246, 0.3);
            --color-text-main: #e6edf3;
            --color-text-muted: #7d8590;
            --font-primary: 'Poppins', sans-serif;
            --font-display: 'Press Start 2P', cursive;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --transition-speed: 0.3s;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--color-background);
            color: var(--color-text-main);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cg fill='%23161B22' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M0 0h4v4H0V0zm4 4h4v4H4V4z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* == SCROLLBAR == */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--color-background); }
        ::-webkit-scrollbar-thumb { background: var(--color-surface-light); border-radius: 10px; border: 2px solid var(--color-background); }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }

        /* == LAYOUT PRINCIPAL (DASHBOARD) == */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas:
                "header header"
                "sidebar main";
            gap: 2rem;
            padding: 2rem;
            min-height: 100vh;
        }
        
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "sidebar"
                    "main";
                padding: 1rem;
                gap: 1rem;
            }
        }

        /* == HEADER == */
        .main-header {
            grid-area: header;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .main-header h1 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--color-primary);
            text-shadow: 0 0 10px var(--color-primary-glow);
        }
        .main-header .user-actions button {
            font-family: var(--font-primary);
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        .main-header .login-btn {
            background-color: var(--color-primary);
            color: var(--color-background);
        }
        .main-header .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--color-primary-glow);
        }
        .main-header .logout-btn {
            background-color: #be123c;
            color: white;
        }
        .main-header .logout-btn:hover {
            background-color: #e11d48;
        }
        #user-email-display {
             font-weight: 600;
        }
        #profile-button {
            font-size: 0.8rem;
            color: var(--color-primary);
        }
        #profile-button:hover { text-decoration: underline; }

        /* == SIDEBAR == */
        .sidebar {
            grid-area: sidebar;
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--color-border);
            height: fit-content; /* Para não esticar em telas grandes */
        }
        .sidebar-section {
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .sidebar-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .sidebar h2 {
            font-family: var(--font-display);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: var(--color-text-main);
        }
        #collection-value { color: var(--color-primary); font-weight: 700; font-size: 1.75rem; }
        #collection-count, #unique-collection-count { font-weight: 600; }
        .progress-bar-container { /* Mantido da versão anterior, com cores ajustadas */
            height: 22px; background-color: #111827; border-radius: 8px; border: 2px solid var(--color-border);
            margin-top: 0.5rem; overflow: hidden; position: relative;
        }
        .progress-bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease-in-out, background 0.5s ease-in-out; }
        .progress-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .sidebar-controls label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--color-text-muted); }
        .sidebar-controls select, .sidebar-controls button {
            width: 100%;
            background-color: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md);
            padding: 0.75rem;
            color: var(--color-text-main);
            font-weight: 500;
        }
        .sidebar-controls select:focus {
             outline: none;
             border-color: var(--color-primary);
             box-shadow: 0 0 0 3px var(--color-primary-glow);
        }
        .share-btn {
            background-color: #166534; color: white; font-weight: 600;
            cursor: pointer; transition: background-color var(--transition-speed) ease;
        }
        .share-btn:hover { background-color: #15803d; }
        
        /* == MAIN CONTENT == */
        .main-content {
            grid-area: main;
            overflow: hidden; /* Evita que elementos "vazem" */
        }
        
        /* == SEARCH COMPONENT 2.0 == */
        .search-container {
            background-color: var(--color-surface);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--color-border);
            margin-bottom: 2rem;
        }
        .search-toggle { display: flex; background-color: var(--color-surface-light); border-radius: var(--border-radius-md); padding: 0.3rem; margin-bottom: 1rem; }
        .search-toggle label {
            flex: 1; text-align: center; padding: 0.6rem;
            border-radius: 6px;
            color: var(--color-text-muted);
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: color var(--transition-speed) ease;
        }
        .search-toggle input[type="radio"] { display: none; } /* Esconde o radio button real */
        .search-toggle input[type="radio"]:checked + label {
            background-color: var(--color-background);
            color: var(--color-text-main);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        #search-input, #set-select {
            width: 100%; background-color: var(--color-surface-light); border: 1px solid var(--color-border); border-radius: var(--border-radius-md);
            padding: 0.75rem 1rem; color: var(--color-text-main); font-size: 1rem;
            transition: all var(--transition-speed) ease;
        }
        #search-input:focus, #set-select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-glow); }
        
        #search-button {
            padding: 0.75rem 2rem; border: none; border-radius: var(--border-radius-md);
            background-color: var(--color-primary); color: var(--color-background); font-weight: 700;
            cursor: pointer; transition: all var(--transition-speed) ease;
        }
        #search-button:hover { transform: translateY(-2px); box-shadow: 0 4px 20px var(--color-primary-glow); }
        
        #search-results, #my-collection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
            max-height: 80vh; /* Para exemplo, pode ser ajustado */
            overflow-y: auto;
            padding: 0 0.5rem 2rem 0; /* Espaço para a scrollbar */
        }
        #my-collection { max-height: calc(100vh - 200px); /* Ajuste de altura da coleção */ }


        /* == CARD COMPONENT 2.0 == */
        .card-item, .collection-card {
            background-color: var(--color-surface-light);
            border-radius: var(--border-radius-lg);
            border: 1px solid transparent;
            text-align: center;
            padding: 0.75rem;
            position: relative;
            transition: all var(--transition-speed) ease;
            transform-style: preserve-3d;
        }
        .card-item:hover { transform: translateY(-5px) scale(1.03); border-color: var(--color-secondary); }
        
        .collection-card { perspective: 1000px; }
        .collection-card:hover { z-index: 10; transform: translateY(-10px) scale(1.05); }
        .collection-card .card-inner {
            position: relative;
            width: 100%; height: 100%;
            transition: transform 0.4s;
            transform-style: preserve-3d;
        }
        .collection-card:hover .card-inner { transform: rotateY(5deg) rotateX(10deg); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }
        .collection-card img { border-radius: var(--border-radius-md); width: 100%; aspect-ratio: 5/7; object-fit: cover; }
        .collection-card .card-name { font-weight: 600; margin-top: 0.75rem; font-size: 0.9rem; }
        .collection-card .card-set { font-size: 0.75rem; color: var(--color-text-muted); display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 0.25rem; }
        .collection-card .card-set img { width: 16px; height: 16px; }
        
        .collection-card .card-controls {
            padding: 0.75rem 0 0.25rem;
            margin-top: 0.75rem;
            border-top: 1px solid var(--color-border);
        }
        .control-group { display: flex; justify-content: space-between; align-items: center; }
        .control-group span { font-size: 1.25rem; font-weight: 700; }
        .control-group .label { font-size: 0.8rem; font-weight: 500; color: var(--color-text-muted); }
        .control-group .label.trade { color: var(--color-primary); }
        .control-group button {
            background: none; border: 1px solid var(--color-border);
            color: var(--color-text-main);
            width: 28px; height: 28px; border-radius: 50%;
            font-size: 1.2rem; line-height: 1;
            cursor: pointer; transition: all var(--transition-speed) ease;
        }
        .control-group button:hover { background-color: var(--color-primary); color: var(--color-background); border-color: var(--color-primary); }


        /* == LOADER == */
        .loader { border: 4px solid var(--color-border); border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* == MODAL == */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content {
            background-color: var(--color-surface);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            width: 90%; max-width: 800px; max-height: 85vh;
            box-shadow: 0 10px 35px rgba(0,0,0,0.4);
            border: 1px solid var(--color-border);
        }
        .modal-content h2 { font-family: var(--font-display); }
        .modal-content input, .modal-content select {
            background-color: var(--color-surface-light); border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md); padding: 0.75rem;
        }
        .modal-content input:focus, .modal-content select:focus {
             outline: none; border-color: var(--color-primary);
        }
        
    </style>
</head>
<body>

    <div class="dashboard-grid">
        <header class="main-header">
            <div>
                <h1>TCG Manager 2.0</h1>
            </div>
            <div id="logged-in-header" class="hidden flex items-center gap-4 user-actions">
                <div class="text-right">
                    <p id="user-email-display" class="text-sm font-semibold"></p>
                    <button id="profile-button" class="text-xs">Editar Perfil</button>
                </div>
                <button id="logout-button" class="logout-btn">Sair</button>
            </div>
            <div id="logged-out-header" class="user-actions">
                <button id="open-auth-modal-btn" class="login-btn">Login / Criar Conta</button>
            </div>
        </header>

        <aside class="sidebar">
            <div class="sidebar-section">
                <h2>Minha Coleção</h2>
                <div class="space-y-2">
                    <p class="text-sm text-gray-400">Valor Estimado</p>
                    <p>R$ <span id="collection-value">0,00</span></p>
                    <p class="text-sm text-gray-400 pt-2"><span id="collection-count">0</span> Cartas (<span id="unique-collection-count">0</span> Únicas)</p>
                </div>
            </div>

            <div id="overall-progress-section" class="sidebar-section hidden">
                <h3 class="text-base font-bold mb-2">Progresso da Pokédex</h3>
                <div class="progress-bar-container">
                    <div id="pokedex-progress-fill" class="progress-bar-fill"></div>
                    <span id="pokedex-progress-text" class="progress-bar-text">0/1025</span>
                </div>
            </div>

            <div class="sidebar-section sidebar-controls space-y-4">
                <div>
                    <label for="group-by-select">Organizar por:</label>
                    <select id="group-by-select">
                        <option value="edition">Edição</option>
                        <option value="pokedex">Pokédex</option>
                        <option value="value">Valor</option>
                    </select>
                </div>
                <div>
                    <button id="share-collection-btn" class="hidden share-btn">
                        Compartilhar Coleção
                    </button>
                </div>
            </div>

             <div id="collection-prompt" class="text-center p-4 bg-gray-800/50 rounded-lg">
                <p class="text-sm text-gray-400">Faça login para ver e gerir a sua coleção.</p>
            </div>
        </aside>

        <main class="main-content">
            <div class="search-container">
                <div class="search-toggle">
                    <input type="radio" name="search-type" value="card" id="search-type-card" class="w-4 h-4" checked>
                    <label for="search-type-card">Buscar por Carta</label>
                    <input type="radio" name="search-type" value="set" id="search-type-set" class="w-4 h-4">
                    <label for="search-type-set">Buscar por Edição</label>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div id="search-input-container" class="w-full">
                        <input type="text" id="search-input" placeholder="Nome da carta ou 058/165">
                    </div>
                    <div id="set-select-container" class="w-full hidden">
                         <select id="set-select">
                            <option>Carregando edições...</option>
                         </select>
                    </div>
                    <button id="search-button">Buscar</button>
                </div>
            </div>

            <div id="loader" class="loader mx-auto hidden"></div>
            <div id="search-results">
                 </div>
            
            <div id="collection-loader" class="loader mx-auto hidden"></div>
            <div id="my-collection">
                 </div>
        </main>
    </div>

    <div id="auth-modal" class="modal-overlay"><div class="modal-content" style="max-width: 450px;"><div class="flex justify-between items-center mb-6"><h2 class="text-xl">Acesso</h2><button id="auth-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white transition-colors">&times;</button></div><div id="login-tab"><h3 class="text-lg text-center mb-4">Login com E-mail</h3><form id="login-form" class="space-y-4" style="font-family: 'Poppins', sans-serif;"><input class="w-full" name="email" type="email" placeholder="Email" required><input class="w-full" name="password" type="password" placeholder="Senha" required><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Entrar</button></form><p class="text-center text-sm text-gray-400 mt-4">Não tem conta? <button id="show-register-btn" class="text-yellow-400 hover:underline">Crie uma.</button></p></div><div id="register-tab" class="hidden"><h3 class="text-lg text-center mb-4">Criar Conta</h3><form id="register-form" class="space-y-4" style="font-family: 'Poppins', sans-serif;"><input class="w-full" name="email" type="email" placeholder="Email" required><input class="w-full" name="password" type="password" placeholder="Senha (mín. 6 caracteres)" required><input class="w-full" name="confirm-password" type="password" placeholder="Confirmar Senha" required><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Criar Conta</button></form><p class="text-center text-sm text-gray-400 mt-4">Já tem conta? <button id="show-login-btn" class="text-yellow-400 hover:underline">Faça login.</button></p></div></div></div>

    <div id="add-card-modal" class="modal-overlay">
        <div class="modal-content flex flex-col" style="max-width: 48rem;">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 class="text-xl">Adicionar à Coleção</h2>
                <button id="add-card-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white transition-colors">&times;</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-8 overflow-y-auto pr-4">
                <img id="modal-card-image" src="" alt="Imagem da carta" class="w-full sm:w-56 flex-shrink-0 rounded-lg aspect-[5/7] object-cover self-start">
                <form id="add-card-form" class="flex-grow flex flex-col" style="font-family: 'Poppins', sans-serif;">
                    <h3 id="modal-card-name" class="text-2xl font-bold"></h3>
                    <div id="modal-card-set-info" class="text-sm text-gray-400 mb-6"></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <label class="block"><span class="block mb-1 font-semibold text-gray-300">Qualidade:</span><select name="quality" id="quality" class="w-full"><option value="Nova">Nova (Mint/NM)</option><option value="Pouco Usada">Pouco Usada (LP)</option><option value="Usada">Usada (Played)</option></select></label>
                        <label class="block"><span class="block mb-1 font-semibold text-gray-300">Acabamento:</span><select name="finish" id="finish" class="w-full"></select></label>
                        <label class="block"><span class="block mb-1 font-semibold text-gray-300">Idioma:</span><select name="language" id="language" class="w-full"><option value="BR">Português (BR)</option><option value="EN">Inglês (EN)</option><option value="JP">Japonês (JP)</option></select></label>
                        <label class="block"><span class="block mb-1 font-semibold text-gray-300">Quantidade:</span><input type="number" name="quantity" id="quantity" value="1" min="1" class="w-full"></label>
                    </div>
                    <div class="mt-auto">
                        <p id="modal-price-display" class="text-xl font-bold text-yellow-400 my-4 text-center sm:text-right">Valor: R$ 0,00</p>
                        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-colors">Confirmar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="details-modal" class="modal-overlay"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl">Detalhes da Carta</h2><button id="details-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white transition-colors">&times;</button></div><div class="flex flex-col sm:flex-row gap-6"><img id="details-card-image" src="" alt="Imagem da carta" class="w-full sm:w-1/3 rounded-lg"><div class="flex-grow" style="font-family: 'Poppins', sans-serif;"><h3 id="details-card-name" class="text-2xl font-bold mb-2"></h3><div id="details-card-set-info" class="mb-4"></div><div class="mb-4"><p class="font-semibold">Qualidade:</p><p id="details-card-quality" class="text-lg text-blue-300"></p></div><div class="mb-4"><p class="font-semibold">Acabamento:</p><p id="details-card-finish" class="text-lg text-cyan-300"></p></div><div><p class="font-semibold">Valor Registado:</p><p id="details-card-price" class="text-lg font-bold text-yellow-400"></p><p class="text-xs text-gray-400 mt-2 italic">*Valor em R$ é uma estimativa.</p></div></div></div></div></div>
    <div id="profile-modal" class="modal-overlay"><div class="modal-content" style="max-width: 500px;"><div class="flex justify-between items-center mb-6"><h2 class="text-xl">Gerenciar Perfil</h2><button id="profile-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white">&times;</button></div><form id="profile-form" style="font-family: 'Poppins', sans-serif;"><div class="mb-4"><label for="profile-name" class="block font-semibold mb-1">Nome / Nickname</label><input type="text" id="profile-name" class="w-full" required></div><div class="mb-4"><label for="profile-social" class="block font-semibold mb-1">Rede Social (opcional)</label><input type="text" id="profile-social" placeholder="instagram.com/seu_perfil" class="w-full"></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Salvar Alterações</button><p id="profile-feedback" class="text-center mt-4 h-5"></p></form></div></div>
    <div id="share-modal" class="modal-overlay"><div class="modal-content" style="max-width: 500px; font-family: 'Poppins', sans-serif;"><div class="flex justify-between items-center mb-4"><h2 class="text-xl" style="font-family: 'Press Start 2P', cursive;">Compartilhar Coleção</h2><button id="share-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white">&times;</button></div><p class="text-gray-400 mb-6">Use o link abaixo para compartilhar uma visão pública da sua coleção com outros treinadores!</p><div class="mb-6"><label for="public-toggle" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="public-toggle" class="sr-only"><div class="block bg-gray-600 w-14 h-8 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition" style="transform: translateX(0); background-color: white;"></div></div><div id="public-status-text" class="ml-3 text-white font-medium">Minha coleção é Privada</div></label></div><div><div class="mb-4"><label for="shareable-link-all" class="block text-sm font-medium text-gray-300 mb-1">Link para Exibição:</label><div class="flex"><input type="text" id="shareable-link-all" readonly class="w-full"><button data-target="shareable-link-all" class="copy-link-btn bg-blue-500 text-white font-bold px-4 rounded-r-lg hover:bg-blue-600">Copiar</button></div></div><div><label for="shareable-link-trade" class="block text-sm font-medium text-gray-300 mb-1">Link para Troca/Venda:</label><div class="flex"><input type="text" id="shareable-link-trade" readonly class="w-full"><button data-target="shareable-link-trade" class="copy-link-btn bg-yellow-500 text-gray-900 font-bold px-4 rounded-r-lg hover:bg-yellow-600">Copiar</button></div></div><p id="copy-feedback" class="text-green-400 text-sm text-center mt-3 h-4"></p></div></div></div>
    <div id="toast-notification" class="fixed bottom-8 right-8 bg-green-600 text-white py-3 px-5 rounded-lg shadow-xl transform translate-y-24 opacity-0 transition-all duration-500 ease-in-out z-[100]" style="font-family: 'Poppins', sans-serif;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Todo o seu script JS original vai aqui, com UMA ÚNICA ALTERAÇÃO.
        // O JavaScript continua o mesmo, exceto pela função 'createCardElement'.
        // Cole seu script aqui, mas substitua a função 'createCardElement' pela que está abaixo.

        document.addEventListener('DOMContentLoaded', async () => {
            const authModal = document.getElementById('auth-modal');
            const authModalCloseBtn = document.getElementById('auth-modal-close-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loggedOutHeader = document.getElementById('logged-out-header');
            const loggedInHeader = document.getElementById('logged-in-header');
            const openAuthModalBtn = document.getElementById('open-auth-modal-btn');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutButton = document.getElementById('logout-button');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');
            const searchInputContainer = document.getElementById('search-input-container');
            const setSelectContainer = document.getElementById('set-select-container');
            const setSelect = document.getElementById('set-select');
            const searchResultsContainer = document.getElementById('search-results');
            const myCollectionContainer = document.getElementById('my-collection');
            const loader = document.getElementById('loader');
            const collectionLoader = document.getElementById('collection-loader');
            const collectionCount = document.getElementById('collection-count');
            const uniqueCollectionCount = document.getElementById('unique-collection-count');
            const collectionValue = document.getElementById('collection-value');
            const groupBySelect = document.getElementById('group-by-select');
            const myCollectionSection = document.getElementById('my-collection-section');
            const collectionPrompt = document.getElementById('collection-prompt');
            const addCardModal = document.getElementById('add-card-modal');
            const addCardForm = document.getElementById('add-card-form');
            const addCardModalCloseBtn = document.getElementById('add-card-modal-close-btn');
            const detailsModal = document.getElementById('details-modal');
            const detailsModalCloseBtn = document.getElementById('details-modal-close-btn'); 
            const shareCollectionBtn = document.getElementById('share-collection-btn');
            const shareModal = document.getElementById('share-modal');
            const shareModalCloseBtn = document.getElementById('share-modal-close-btn');
            const publicToggle = document.getElementById('public-toggle');
            const publicStatusText = document.getElementById('public-status-text');
            const copyFeedback = document.getElementById('copy-feedback');
            const profileModal = document.getElementById('profile-modal');
            const profileModalCloseBtn = document.getElementById('profile-modal-close-btn');
            const profileButton = document.getElementById('profile-button');
            const profileForm = document.getElementById('profile-form');
            const profileNameInput = document.getElementById('profile-name');
            const profileFeedback = document.getElementById('profile-feedback');
            const toastNotification = document.getElementById('toast-notification');
            
            let currentUserId = null;
            let searchCache = new Map();
            let collectionData = new Map();
            let collectionUnsubscribe = null;
            let usdToBrlRate = 5.3;
            let db, auth;
            
            profileButton.addEventListener('click', async () => {
                if (auth.currentUser) {
                    profileNameInput.value = auth.currentUser.displayName || '';
                    const profileRef = doc(db, 'public_profiles', auth.currentUser.uid);
                    const profileSnap = await getDoc(profileRef);
                    if (profileSnap.exists() && profileSnap.data().socialLink) {
                        document.getElementById('profile-social').value = profileSnap.data().socialLink;
                    } else {
                        document.getElementById('profile-social').value = '';
                    }
                    profileFeedback.textContent = '';
                    profileModal.style.display = 'flex';
                }
            });

            profileModalCloseBtn.addEventListener('click', () => {
                profileModal.style.display = 'none';
            });

            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = profileNameInput.value.trim();
                let socialLink = document.getElementById('profile-social').value.trim();

                if (!newName) {
                    profileFeedback.textContent = 'O nickname não pode ficar em branco.';
                    profileFeedback.classList.add('text-red-400');
                    return;
                }
                if (!auth.currentUser) return;

                if (socialLink && !socialLink.startsWith('http://') && !socialLink.startsWith('https://')) {
                    socialLink = 'https://' + socialLink;
                }

                profileFeedback.textContent = 'Salvando...';
                profileFeedback.classList.remove('text-red-400', 'text-green-400');

                try {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    const profileRef = doc(db, 'public_profiles', auth.currentUser.uid);
                    await setDoc(profileRef, { 
                        ownerName: newName,
                        socialLink: socialLink 
                    }, { merge: true });

                    userEmailDisplay.textContent = newName;
                    profileFeedback.textContent = 'Perfil atualizado com sucesso!';
                    profileFeedback.classList.add('text-green-400');

                    setTimeout(() => {
                        profileModal.style.display = 'none';
                    }, 1500);
                } catch (error) {
                    console.error("Erro ao atualizar perfil:", error);
                    profileFeedback.textContent = 'Erro ao salvar. Tente novamente.';
                    profileFeedback.classList.add('text-red-400');
                }
            });

            const getFinishDisplayName = (key) => {
                const names = { normal: 'Normal', holofoil: 'Holo', reverseHolofoil: 'Reverse Holo', '1stEditionHolofoil': '1ª Edição Holo', '1stEditionNormal': '1ª Edição Normal', unlimitedHolofoil: 'Unlimited Holo' };
                return names[key] || key;
            };

            const fetchExchangeRate = async () => {
                const cacheKey = 'exchangeRateCache';
                const cachedRate = sessionStorage.getItem(cacheKey);
                if (cachedRate) {
                    usdToBrlRate = parseFloat(cachedRate);
                    return;
                }
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error('API de câmbio falhou');
                    const data = await response.json();
                    usdToBrlRate = data.rates.BRL;
                    sessionStorage.setItem(cacheKey, usdToBrlRate);
                } catch (error) {
                    console.error("Não foi possível buscar a taxa de câmbio, usando valor padrão.", error);
                }
            };
            
            function fillSetDropdown(sets) {
                setSelect.innerHTML = '<option value="">Selecione uma edição...</option>';
                sets.forEach(set => {
                    const option = document.createElement('option');
                    option.value = set.id;
                    option.textContent = set.name;
                    setSelect.appendChild(option);
                });
            }

            const populateSetDropdown = async () => {
                const cacheKey = 'pokemonSetsCache';
                const cachedData = sessionStorage.getItem(cacheKey);
                if (cachedData) {
                    fillSetDropdown(JSON.parse(cachedData));
                    return;
                }
                try {
                    const response = await fetch('https://api.pokemontcg.io/v2/sets');
                    if (!response.ok) throw new Error('Falha ao buscar edições');
                    const data = await response.json();
                    const sortedSets = data.data.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));
                    sessionStorage.setItem(cacheKey, JSON.stringify(sortedSets));
                    fillSetDropdown(sortedSets);
                } catch (error) {
                    console.error("Erro ao popular dropdown de edições:", error);
                }
            };

            const toggleSearchMode = () => {
                const searchType = document.querySelector('input[name="search-type"]:checked').value;
                if (searchType === 'card') {
                    searchInputContainer.classList.remove('hidden');
                    setSelectContainer.classList.add('hidden');
                } else {
                    searchInputContainer.classList.add('hidden');
                    setSelectContainer.classList.remove('hidden');
                }
            };
            
            searchTypeRadios.forEach(radio => radio.addEventListener('change', toggleSearchMode));

            const searchCards = async () => {
                const searchType = document.querySelector('input[name="search-type"]:checked').value;
                let searchTerm = '', query = '', postFilter = null;
                if (searchType === 'set') {
                    searchTerm = setSelect.value;
                    if (!searchTerm) { alert('Por favor, selecione uma edição.'); return; }
                    query = `set.id:"${searchTerm}"`;
                } else {
                    searchTerm = searchInput.value.trim();
                    if (!searchTerm) return;
                    const numberMatch = searchTerm.match(/^(\d+)\/(\d+)$/);
                    if (numberMatch) {
                        query = `number:"${parseInt(numberMatch[1], 10)}"`;
                        postFilter = (cards) => cards.filter(card => card.set.printedTotal === parseInt(numberMatch[2], 10));
                    } else {
                        query = `name:"${searchTerm}*"`;
                    }
                }
                loader.classList.remove('hidden');
                searchResultsContainer.innerHTML = '';
                searchCache.clear();
                try {
                    const response = await fetch(`https://api.pokemontcg.io/v2/cards?q=${encodeURIComponent(query)}`);
                    if (!response.ok) throw new Error('A resposta da rede não foi "ok".');
                    const data = await response.json();
                    let cardsToShow = data.data || [];
                    if (postFilter) cardsToShow = postFilter(cardsToShow);
                    displaySearchResults(cardsToShow);
                } catch (error) {
                    console.error("Falha ao buscar cartas:", error);
                    searchResultsContainer.innerHTML = `<p class="text-red-400 text-center col-span-full">Erro ao buscar cartas.</p>`;
                } finally {
                    loader.classList.add('hidden');
                }
            };

            const displaySearchResults = (cards) => {
                searchResultsContainer.innerHTML = '';
                if (!cards || cards.length === 0) {
                    searchResultsContainer.innerHTML = `<p class="text-center text-gray-400 col-span-full">Nenhuma carta encontrada.</p>`;
                    return;
                }
                cards.forEach(card => {
                    searchCache.set(card.id, card);
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card-item relative';
                    cardElement.innerHTML = `<div class="card-inner"><img src="${card.images.small}" alt="${card.name}" class="rounded-lg shadow-lg w-full"><button data-card-id="${card.id}" class="open-add-modal-btn absolute bottom-2 right-2 bg-yellow-500 hover:bg-yellow-600 text-gray-900 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-transform duration-200 hover:scale-110">+</button></div>`;
                    searchResultsContainer.appendChild(cardElement);
                });
                document.querySelectorAll('.open-add-modal-btn').forEach(button => button.addEventListener('click', (e) => openAddCardModal(e.currentTarget.dataset.cardId)));
            };
            
            const openAddCardModal = (cardId) => {
                if (!currentUserId) { authModal.style.display = 'flex'; return; }
                const card = searchCache.get(cardId);
                if (!card) return;
                document.getElementById('modal-card-image').src = card.images.small;
                document.getElementById('modal-card-name').textContent = card.name;
                const releaseYear = new Date(card.set.releaseDate).getFullYear();
                document.getElementById('modal-card-set-info').innerHTML = `<span class="flex items-center gap-2">${card.set.name} <img src="${card.set.images.symbol}" class="h-5" alt="${card.set.name}"></span> ${releaseYear} &bull; #${String(card.number).padStart(3, '0')} / ${card.set.printedTotal}`;
                
                const finishSelect = document.getElementById('finish');
                finishSelect.innerHTML = '';
                const prices = card.tcgplayer?.prices || {};
                const availableFinishes = new Set();
                ['normal', ...Object.keys(prices)].forEach(key => {
                    if (key === 'normal' || (prices[key] && !availableFinishes.has(key.toLowerCase()))) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = getFinishDisplayName(key);
                        finishSelect.appendChild(option);
                        availableFinishes.add(key.toLowerCase());
                    }
                });
                addCardForm.dataset.cardId = card.id;
                addCardForm.reset();
                updatePriceDisplay();
                addCardModal.style.display = 'flex';
            };

            const updatePriceDisplay = () => {
                const cardId = addCardForm.dataset.cardId, card = searchCache.get(cardId), quality = addCardForm.quality.value, finish = addCardForm.finish.value;
                let priceUsd = 0;
                if (card?.tcgplayer?.prices?.[finish]) {
                    const prices = card.tcgplayer.prices[finish];
                    priceUsd = quality === 'Nova' ? prices.market || prices.mid || 0 : (quality === 'Pouco Usada' ? prices.mid || prices.low || 0 : prices.low || 0);
                }
                const priceBrl = priceUsd * usdToBrlRate;
                document.getElementById('modal-price-display').textContent = `Valor estimado: R$ ${priceBrl.toFixed(2)}`;
                addCardForm.dataset.currentPrice = priceBrl.toFixed(2);
            };
            
            async function handleAddFormSubmit(e) {
                e.preventDefault();
                const cardId = addCardForm.dataset.cardId, card = searchCache.get(cardId), quality = addCardForm.quality.value, finishKey = addCardForm.finish.value;
                const cardData = {
                    id: card.id, name: card.name, image: card.images.small,
                    set: { id: card.set.id, name: card.set.name, series: card.set.series, printedTotal: card.set.printedTotal, total: card.set.total, releaseDate: card.set.releaseDate, images: { symbol: card.set.images.symbol, logo: card.set.images.logo } },
                    number: card.number, quality: quality, finish: getFinishDisplayName(finishKey), acquiredPrice: parseFloat(String(addCardForm.dataset.currentPrice).replace(',', '.')),
                    pokedexNumber: card.nationalPokedexNumbers?.[0] || null, language: document.getElementById('language').value
                };
                if (!currentUserId) return;
                const docId = `${cardData.id}-${cardData.quality}-${cardData.finish}-${cardData.language}`;
                const cardRef = doc(db, `users/${currentUserId}/tcg-collection`, docId), docSnap = await getDoc(cardRef);
                const quantityToAdd = parseInt(addCardForm.quantity.value, 10) || 1;
                if (docSnap.exists()) await updateDoc(cardRef, { quantityTotal: increment(quantityToAdd) });
                else await setDoc(cardRef, { ...cardData, quantityTotal: quantityToAdd, quantityForTrade: 0 });
                addCardModal.style.display = 'none';
                toastNotification.innerHTML = `<strong>${card.name}</strong> adicionado à coleção!`;
                toastNotification.classList.remove('opacity-0', 'translate-y-24');
                setTimeout(() => toastNotification.classList.add('opacity-0', 'translate-y-24'), 3000);
            }
            
            const openDetailsModal = (docId) => {
                const card = collectionData.get(docId);
                if (!card) return;
                document.getElementById('details-card-image').src = card.image;
                document.getElementById('details-card-name').textContent = card.name;
                const releaseYear = new Date(card.set.releaseDate).getFullYear();
                document.getElementById('details-card-set-info').innerHTML = `<span class="flex items-center gap-2 text-lg">${card.set.name} <img src="${card.set.images.symbol}" class="h-6" alt="${card.set.name}"></span> <span class="text-sm text-gray-400">${releaseYear} &bull; #${String(card.number).padStart(3, '0')} / ${card.set.printedTotal}</span>`;
                document.getElementById('details-card-quality').textContent = card.quality;
                document.getElementById('details-card-finish').textContent = card.finish;
                document.getElementById('details-card-price').textContent = `R$ ${(card.acquiredPrice || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                detailsModal.style.display = 'flex';
            };

            const handleCollectionClick = async (e) => {
                const cardContainer = e.target.closest('.collection-card');
                if (!cardContainer) return;
                const docId = cardContainer.dataset.id;
                const action = e.target.dataset.action;
                if (!action) { openDetailsModal(docId); return; }
                if (!currentUserId) return;
                const cardRef = doc(db, `users/${currentUserId}/tcg-collection`, docId);
                const card = collectionData.get(docId);
                switch (action) {
                    case 'total-plus': await updateDoc(cardRef, { quantityTotal: increment(1) }); break;
                    case 'total-minus':
                        if (card.quantityTotal > 1 && card.quantityTotal > (card.quantityForTrade || 0)) await updateDoc(cardRef, { quantityTotal: increment(-1) });
                        else if (card.quantityTotal === 1 && confirm(`Remover ${card.name} da coleção?`)) await deleteDoc(cardRef);
                        break;
                    case 'trade-plus': if ((card.quantityForTrade || 0) < card.quantityTotal) await updateDoc(cardRef, { quantityForTrade: increment(1) }); break;
                    case 'trade-minus': if ((card.quantityForTrade || 0) > 0) await updateDoc(cardRef, { quantityForTrade: increment(-1) }); break;
                }
            };
            
            const loadMyCollection = () => {
                if (!currentUserId) return;
                collectionLoader.classList.remove('hidden');
                collectionPrompt.classList.add('hidden');
                document.getElementById('overall-progress-section').classList.remove('hidden');
                const collectionRef = collection(db, `users/${currentUserId}/tcg-collection`);
                collectionUnsubscribe = onSnapshot(collectionRef, (snapshot) => {
                    collectionLoader.classList.add('hidden');
                    collectionData.clear();
                    snapshot.docs.forEach(doc => {
                        const card = { ...doc.data(), docId: doc.id };
                        if (card.quantityForTrade === undefined) card.quantityForTrade = 0;
                        collectionData.set(doc.id, card);
                    });
                    renderCollection();
                }, (error) => { console.error("Erro ao carregar a coleção:", error); });
            };

            const renderCollection = () => {
                if (!collectionData) return;
                let totalCards = 0, totalValue = 0;
                const allCards = Array.from(collectionData.values());
                allCards.forEach(card => {
    totalCards += card.quantityTotal;

    // A LINHA CRUCIAL DA CORREÇÃO ESTÁ AQUI:
    // Verificamos se 'acquiredPrice' NÃO é NaN antes de somar.
    // Se for NaN ou indefinido, somamos 0 ao valor total.
    const price = card.acquiredPrice;
    if (price && !isNaN(price)) {
        totalValue += price * card.quantityTotal;
    }
});
                const ownedPokedexNumbers = new Set(allCards.map(c => c.pokedexNumber).filter(Boolean));
                const pokedexPercentage = (ownedPokedexNumbers.size / 1025) * 100;
                const fill = document.getElementById('pokedex-progress-fill');
                fill.style.width = `${pokedexPercentage}%`;
                fill.style.background = pokedexPercentage < 30 ? 'linear-gradient(to right, #ef4444, #f87171)' : (pokedexPercentage < 60 ? 'linear-gradient(to right, #f59e0b, #facc15)' : 'linear-gradient(to right, #22c55e, #4ade80)');
                document.getElementById('pokedex-progress-text').textContent = `${ownedPokedexNumbers.size} / 1025`;

                collectionCount.textContent = totalCards;
                uniqueCollectionCount.textContent = collectionData.size;
                collectionValue.textContent = totalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                myCollectionContainer.innerHTML = '';
                if (collectionData.size === 0) {
                    myCollectionContainer.innerHTML = `<p class="text-center text-gray-400 col-span-full py-10">Sua coleção está vazia.</p>`;
                    return;
                }
                
                const groupBy = groupBySelect.value;
                if (groupBy === 'pokedex') allCards.sort((a, b) => (a.pokedexNumber || 9999) - (b.pokedexNumber || 9999));
                else if (groupBy === 'value') allCards.sort((a, b) => (b.acquiredPrice || 0) - (a.acquiredPrice || 0));
                else {
                    const grouped = allCards.reduce((acc, card) => {
                        (acc[card.set.name] = acc[card.set.name] || []).push(card);
                        return acc;
                    }, {});
                    const sortedGroupKeys = Object.keys(grouped).sort((a,b) => new Date(grouped[b][0].set.releaseDate) - new Date(grouped[a][0].set.releaseDate));
                    myCollectionContainer.innerHTML = ''; // Limpa para renderizar grupos
                    sortedGroupKeys.forEach(groupName => {
                        const header = document.createElement('h3');
                        header.className = 'text-lg font-bold col-span-full mt-4 border-b border-gray-700 pb-2';
                        header.textContent = groupName;
                        myCollectionContainer.appendChild(header);
                        grouped[groupName]
                            .sort((a, b) => (parseInt(String(a.number).replace(/\D/g, '')) || 0) - (parseInt(String(b.number).replace(/\D/g, '')) || 0))
                            .forEach(card => myCollectionContainer.appendChild(createCardElement(card)));
                    });
                    return; // Retorna para não renderizar novamente
                }
                allCards.forEach(card => myCollectionContainer.appendChild(createCardElement(card)));
            };

            // NOVA // NOVA FUNÇÃO createCardElement ATUALIZADA
            const createCardElement = (card) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'collection-card cursor-pointer';
                cardElement.dataset.id = card.docId;

                // Formata o preço individual para exibição
                const cardPrice = (card.acquiredPrice || 0).toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });

                const cardHTML = `
                    <div class="card-inner">
                        <img src="${card.image}" alt="${card.name}">
                        <p class="card-name">${card.name}</p>
                        <div class="card-set">
                            <img src="${card.set.images.symbol}" alt="Set Symbol">
                            <span>#${String(card.number).padStart(3, '0')}</span>
                        </div>
                        
                        <p class="font-bold text-yellow-400 text-sm mt-2">${cardPrice}</p>

                        <div class="card-controls">
                            <div class="control-group">
                                <div class="text-left">
                                    <div class="label">Total</div>
                                    <div class="flex items-center gap-2">
                                        <button data-action="total-minus" data-id="${card.docId}">-</button>
                                        <span>${card.quantityTotal}</span>
                                        <button data-action="total-plus" data-id="${card.docId}">+</button>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="label trade">P/ Troca</div>
                                    <div class="flex items-center gap-2">
                                        <button data-action="trade-minus" data-id="${card.docId}">-</button>
                                        <span>${card.quantityForTrade || 0}</span>
                                        <button data-action="trade-plus" data-id="${card.docId}">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                cardElement.innerHTML = cardHTML;
                return cardElement;
            };

            const updateShareUI = (isPublic) => {
                publicToggle.checked = isPublic;
                const statusText = document.getElementById('public-status-text');
                const linkAll = document.getElementById('shareable-link-all');
                const linkTrade = document.getElementById('shareable-link-trade');
                if (isPublic) {
                    statusText.textContent = "Minha coleção é Pública"; statusText.classList.add('text-green-400'); statusText.classList.remove('text-white');
                    const baseURL = `${window.location.origin}${window.location.pathname.replace('index.html', '')}share.html?user=${currentUserId}`;
                    linkAll.value = baseURL;
                    linkTrade.value = `${baseURL}&list=trade`;
                } else {
                    statusText.textContent = "Minha coleção é Privada"; statusText.classList.remove('text-green-400'); statusText.classList.add('text-white');
                    linkAll.value = 'Torne sua coleção pública para gerar o link';
                    linkTrade.value = 'Torne sua coleção pública para gerar o link';
                }
            };
            
            try {
                await Promise.all([fetchExchangeRate(), populateSetDropdown()]);
            } catch (error) { console.error("Erro nas chamadas iniciais:", error); }
            
            toggleSearchMode();
            searchButton.addEventListener('click', searchCards);
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchCards(); });
            addCardForm.addEventListener('submit', handleAddFormSubmit);
            addCardForm.quality.addEventListener('change', updatePriceDisplay);
            addCardForm.finish.addEventListener('change', updatePriceDisplay);
            myCollectionContainer.addEventListener('click', handleCollectionClick);
            groupBySelect.addEventListener('change', renderCollection);
            openAuthModalBtn.addEventListener('click', () => authModal.style.display = 'flex');
            authModalCloseBtn.addEventListener('click', () => authModal.style.display = 'none');
            showRegisterBtn.addEventListener('click', () => { loginTab.classList.add('hidden'); registerTab.classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', () => { registerTab.classList.add('hidden'); loginTab.classList.remove('hidden'); });
            loginForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value); authModal.style.display = 'none'; } catch (error) { alert(`Erro: ${error.message}`); }});
            registerForm.addEventListener('submit', async (e) => { e.preventDefault(); if (registerForm.password.value !== registerForm['confirm-password'].value) { alert("As senhas não coincidem!"); return; } try { await createUserWithEmailAndPassword(auth, registerForm.email.value, registerForm.password.value); authModal.style.display = 'none'; } catch (error) { alert(`Erro: ${error.message}`); }});
            logoutButton.addEventListener('click', () => signOut(auth));
            shareCollectionBtn.addEventListener('click', async () => { if (!currentUserId) return; const snap = await getDoc(doc(db, 'public_profiles', currentUserId)); updateShareUI(snap.exists() && snap.data().isPublic); shareModal.style.display = 'flex'; });
            publicToggle.addEventListener('change', async () => { if (!currentUserId) return; await setDoc(doc(db, 'public_profiles', currentUserId), { isPublic: publicToggle.checked, ownerName: auth.currentUser.displayName || auth.currentUser.email }, { merge: true }); updateShareUI(publicToggle.checked); });
            document.querySelectorAll('.copy-link-btn').forEach(button => button.addEventListener('click', () => { if (publicToggle.checked) { document.getElementById(button.dataset.target).select(); document.execCommand('copy'); copyFeedback.textContent = 'Link copiado!'; setTimeout(() => { copyFeedback.textContent = '' }, 2000); } }));
            [detailsModalCloseBtn, profileModalCloseBtn, shareModalCloseBtn].forEach(btn => btn.addEventListener('click', () => btn.closest('.modal-overlay').style.display = 'none'));

            const firebaseConfig = { apiKey: "AIzaSyDZTXYGAHje-ZFnnhoiNwEUkNAmq63tY68", authDomain: "pokemtcgcard.firebaseapp.com", projectId: "pokemtcgcard", storageBucket: "pokemtcgcard.firebasestorage.app", messagingSenderId: "1056735056128", appId: "1:1056735056128:web:d47f0474b925246c0de3e5", measurementId: "G-JBPHZ0EQWC" };
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                if (collectionUnsubscribe) collectionUnsubscribe();
                currentUserId = user?.uid || null;
                loggedInHeader.classList.toggle('hidden', !user);
                loggedOutHeader.classList.toggle('hidden', !!user);
                collectionPrompt.classList.toggle('hidden', !!user);
                document.getElementById('overall-progress-section').classList.toggle('hidden', !user);
                shareCollectionBtn.classList.toggle('hidden', !user);

                if (user) {
                    userEmailDisplay.textContent = user.displayName || user.email;
                    loadMyCollection();
                } else {
                    myCollectionContainer.innerHTML = '';
                    ['collection-count', 'unique-collection-count'].forEach(id => document.getElementById(id).textContent = '0');
                    document.getElementById('collection-value').textContent = '0,00';
                }
            });
        });
    </script>
</body>
</html>
