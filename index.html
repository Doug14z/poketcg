<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Pokémon TCG 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-background: #0D1117;
            --color-surface: #161B22;
            --color-surface-light: #222831;
            --color-border: #30363D;
            --color-primary: #f59e0b;
            --color-primary-glow: rgba(245, 158, 11, 0.5);
            --color-secondary: #3b82f6;
            --color-text-main: #e6edf3;
            --color-text-muted: #7d8590;
            --font-primary: 'Poppins', sans-serif;
            --font-display: 'Press Start 2P', cursive;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --transition-speed: 0.3s;
        }
        body {
            font-family: var(--font-primary);
            background-color: var(--color-background);
            color: var(--color-text-main);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cg fill='%23161B22' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M0 0h4v4H0V0zm4 4h4v4H4V4z'/%3E%3C/g%3E%3C/svg%3E");
        }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--color-background); }
        ::-webkit-scrollbar-thumb { background: var(--color-surface-light); border-radius: 10px; border: 2px solid var(--color-background); }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas: "header header" "sidebar main";
            gap: 2rem;
            padding: 2rem;
            min-height: 100vh;
        }
        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: 1fr; grid-template-areas: "header" "sidebar" "main"; padding: 1rem; gap: 1.5rem; }
        }
        .main-header {
            grid-area: header; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            gap: 1rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border);
        }
        .main-header h1 { font-family: var(--font-display); font-size: 1.5rem; color: var(--color-primary); text-shadow: 0 0 10px var(--color-primary-glow); }
        .main-header .user-actions button {
            font-family: var(--font-primary); font-weight: 600; padding: 0.6rem 1.2rem; border: none;
            border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) ease;
        }
        .main-header .login-btn { background-color: var(--color-primary); color: var(--color-background); }
        .main-header .login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px var(--color-primary-glow); }
        .main-header .logout-btn { background-color: #be123c; color: white; }
        .main-header .logout-btn:hover { background-color: #e11d48; }
        #user-email-display { font-weight: 600; }
        #profile-button { font-size: 0.8rem; color: var(--color-primary); }
        #profile-button:hover { text-decoration: underline; }
        .sidebar { grid-area: sidebar; background-color: var(--color-surface); border-radius: var(--border-radius-lg); padding: 1.5rem; border: 1px solid var(--color-border); height: fit-content; }
        .sidebar-section { padding-bottom: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
        .sidebar-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .sidebar h2 { font-family: var(--font-display); font-size: 1rem; margin-bottom: 1.5rem; color: var(--color-text-main); }
        #collection-value { color: var(--color-primary); font-weight: 700; font-size: 1.75rem; }
        #collection-count, #unique-collection-count { font-weight: 600; }
        .progress-bar-container { height: 22px; background-color: #111827; border-radius: 8px; border: 2px solid var(--color-border); margin-top: 0.5rem; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease-in-out, background 0.5s ease-in-out; }
        .progress-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .sidebar-controls label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--color-text-muted); }
        .sidebar-controls select, .sidebar-controls button { width: 100%; background-color: var(--color-surface-light); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.75rem; color: var(--color-text-main); font-weight: 500; }
        .sidebar-controls select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-glow); }
        #share-collection-btn { background-color: #166534; color: white; font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed) ease; }
        #share-collection-btn:hover { background-color: #15803d; }
        .main-content { grid-area: main; overflow: hidden; }
        .search-container { background-color: var(--color-surface); padding: 1.5rem; border-radius: var(--border-radius-lg); border: 1px solid var(--color-border); margin-bottom: 2rem; }
        .search-toggle { display: flex; background-color: var(--color-surface-light); border-radius: var(--border-radius-md); padding: 0.3rem; margin-bottom: 1rem; }
        .search-toggle label { flex: 1; text-align: center; padding: 0.6rem; border-radius: 6px; color: var(--color-text-muted); font-weight: 600; cursor: pointer; position: relative; transition: color var(--transition-speed) ease; }
        input[type="radio"] { display: none; }
        .search-toggle input[type="radio"]:checked + label { background-color: var(--color-background); color: var(--color-text-main); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #search-input, #set-select { width: 100%; background-color: var(--color-surface-light); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.75rem 1rem; color: var(--color-text-main); font-size: 1rem; transition: all var(--transition-speed) ease; }
        #search-input:focus, #set-select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-glow); }
        #search-button { padding: 0.75rem 2rem; border: none; border-radius: var(--border-radius-md); background-color: var(--color-primary); color: var(--color-background); font-weight: 700; cursor: pointer; transition: all var(--transition-speed) ease; }
        #search-button:hover { transform: translateY(-2px); box-shadow: 0 4px 20px var(--color-primary-glow); }
        #search-results, #my-collection { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; overflow-y: auto; padding: 0.5rem; }
        #my-collection { max-height: calc(100vh - 120px); }
        .card-item, .collection-card { background-color: var(--color-surface); border-radius: var(--border-radius-lg); border: 1px solid var(--color-border); text-align: center; padding: 1rem; position: relative; transition: all var(--transition-speed) ease; transform-style: preserve-3d; }
        .card-item:hover { transform: translateY(-5px) scale(1.03); border-color: var(--color-secondary); }
        .collection-card { perspective: 1000px; }
        .collection-card:hover { z-index: 10; transform: translateY(-8px); box-shadow: 0 20px 30px -10px rgba(0,0,0,0.5); border-color: var(--color-primary); }
        .collection-card .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s ease; transform-style: preserve-3d; }
        .collection-card:hover .card-inner { transform: rotateY(3deg) rotateX(5deg); }
        .collection-card img { border-radius: var(--border-radius-md); width: 100%; aspect-ratio: 5/7; object-fit: cover; }
        .loader { border: 4px solid var(--color-border); border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(8px); }
        .modal-content { background-color: rgba(22, 27, 34, 0.9); padding: 2rem; border-radius: var(--border-radius-lg); width: 90%; max-width: 800px; max-height: 85vh; box-shadow: 0 10px 35px rgba(0,0,0,0.4); border: 1px solid var(--color-border); }
        .modal-content h2 { font-family: var(--font-display); }
        .group-header-wrapper { grid-column: 1 / -1; background-color: var(--color-surface); padding: 0.75rem 1.25rem; border-radius: var(--border-radius-md); margin: 1.5rem 0 1rem 0; border: 1px solid var(--color-border); }
        .group-header { color: var(--color-text-main); font-family: var(--font-display); font-size: 0.9rem; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="dashboard-grid">
        <header class="main-header">
            <div>
                <h1>TCG Manager</h1>
            </div>
            <div id="logged-in-header" class="hidden">
                 <div class="flex items-center gap-4 user-actions">
                    <div class="text-right">
                        <p id="user-email-display" class="text-sm"></p>
                        <button id="profile-button" class="text-xs">Editar Perfil</button>
                    </div>
                    <button id="logout-button" class="logout-btn">Sair</button>
                </div>
            </div>
            <div id="logged-out-header" class="user-actions">
                <button id="open-auth-modal-btn" class="login-btn">Login / Criar Conta</button>
            </div>
        </header>

        <aside class="sidebar">
            <div class="sidebar-section">
                <h2>Minha Coleção</h2>
                <div class="space-y-2">
                    <p class="text-sm text-gray-400">Valor Estimado</p>
                    <p>R$ <span id="collection-value">0,00</span></p>
                    <p class="text-sm text-gray-400 pt-2"><span id="collection-count">0</span> Cartas (<span id="unique-collection-count">0</span> Únicas)</p>
                </div>
            </div>

            <div id="overall-progress-section" class="sidebar-section hidden">
                <h3 class="text-base font-bold mb-2 text-center">Progresso da Pokédex</h3>
                <div class="progress-bar-container">
                    <div id="pokedex-progress-fill" class="progress-bar-fill"></div>
                    <span id="pokedex-progress-text" class="progress-bar-text">0/1025</span>
                </div>
            </div>

            <div class="sidebar-section sidebar-controls space-y-4">
                 <div>
                    <label for="group-by-select">Organizar por:</label>
                    <select id="group-by-select">
                        <option value="edition">Edição</option>
                        <option value="pokedex">Pokédex</option>
                        <option value="value">Valor</option>
                    </select>
                </div>
                <div>
                    <button id="share-collection-btn" class="hidden share-btn">Compartilhar Coleção</button>
                </div>
            </div>
        </aside>

        <main class="main-content flex flex-col">
            <div class="search-container">
                 <h2 class="text-lg font-bold mb-4" style="font-family: var(--font-display)">Buscar Cartas</h2>
                <div class="search-toggle">
                    <input type="radio" name="search-type" value="card" id="search-type-card" checked>
                    <label for="search-type-card">Por Carta</label>
                    <input type="radio" name="search-type" value="set" id="search-type-set">
                    <label for="search-type-set">Por Edição</label>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div id="search-input-container" class="w-full">
                        <input type="text" id="search-input" placeholder="Nome da carta ou 058/165">
                    </div>
                    <div id="set-select-container" class="w-full hidden">
                         <select id="set-select">
                            <option>Carregando edições...</option>
                         </select>
                    </div>
                    <button id="search-button">Buscar</button>
                </div>
            </div>
            
            <div class="flex-grow overflow-hidden relative">
                <div id="loader" class="loader mx-auto hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
                <div id="search-results" class="h-full"></div>
            </div>

            <div id="my-collection-section" class="mt-8">
                 <div id="collection-prompt" class="text-center p-8 bg-gray-800/50 rounded-lg">
                    <p class="text-gray-400">Faça login para ver e gerir a sua coleção.</p>
                </div>
                <div id="collection-loader" class="loader mx-auto hidden"></div>
                <div id="my-collection" class="h-full"></div>
            </div>
        </main>
    </div>

    <div id="auth-modal" class="modal-overlay">...</div>
    <div id="add-card-modal" class="modal-overlay">...</div>
    <div id="details-modal" class="modal-overlay">...</div>
    <div id="profile-modal" class="modal-overlay">...</div>
    <div id="share-modal" class="modal-overlay">...</div>
    <div id="toast-notification" class="fixed bottom-8 right-8 ..."></div>


    <script type="module">
        // --- CÓDIGO FUNCIONAL V1.5 COM MELHORIAS DE PERFORMANCE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const authModal = document.getElementById('auth-modal');
            const authModalCloseBtn = document.querySelector('#auth-modal button'); // Seletor ajustado
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loggedOutHeader = document.getElementById('logged-out-header');
            const loggedInHeader = document.getElementById('logged-in-header');
            const openAuthModalBtn = document.getElementById('open-auth-modal-btn');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutButton = document.getElementById('logout-button');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');
            const searchInputContainer = document.getElementById('search-input-container');
            const setSelectContainer = document.getElementById('set-select-container');
            const setSelect = document.getElementById('set-select');
            const searchResultsContainer = document.getElementById('search-results');
            const myCollectionContainer = document.getElementById('my-collection');
            const loader = document.getElementById('loader');
            const collectionLoader = document.getElementById('collection-loader');
            const collectionCount = document.getElementById('collection-count');
            const uniqueCollectionCount = document.getElementById('unique-collection-count');
            const collectionValue = document.getElementById('collection-value');
            const groupBySelect = document.getElementById('group-by-select');
            const collectionPrompt = document.getElementById('collection-prompt');
            const addCardModal = document.getElementById('add-card-modal');
            const addCardForm = document.getElementById('add-card-form');
            const profileButton = document.getElementById('profile-button');
            
            let currentUserId = null;
            let searchCache = new Map();
            let collectionData = new Map();
            let collectionUnsubscribe = null;
            let usdToBrlRate = 5.4; // Taxa padrão
            let db, auth;

            const fetchExchangeRate = async () => {
                const cacheKey = 'exchangeRateCache';
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) { usdToBrlRate = parseFloat(cached); return; }
                try {
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    const data = await res.json();
                    usdToBrlRate = data.rates.BRL;
                    sessionStorage.setItem(cacheKey, usdToBrlRate);
                } catch (err) { console.error("Erro ao buscar câmbio.", err); }
            };

            const populateSetDropdown = async () => {
                const cacheKey = 'pokemonSetsCache';
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) { fillSetDropdown(JSON.parse(cached)); return; }
                try {
                    const res = await fetch('https://api.pokemontcg.io/v2/sets');
                    const data = await res.json();
                    const sorted = data.data.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));
                    sessionStorage.setItem(cacheKey, JSON.stringify(sorted));
                    fillSetDropdown(sorted);
                } catch (err) { console.error("Erro ao buscar sets.", err); }
            };

            function fillSetDropdown(sets) {
                setSelect.innerHTML = '<option value="">Selecione uma edição...</option>';
                sets.forEach(set => {
                    const option = document.createElement('option');
                    option.value = set.id;
                    option.textContent = set.name;
                    setSelect.appendChild(option);
                });
            }

            const getFinishDisplayName = (key) => {
                const names = { normal: 'Normal', holofoil: 'Holo', reverseHolofoil: 'Reverse Holo', '1stEditionHolofoil': '1ª Edição Holo' };
                return names[key] || key;
            };

            const toggleSearchMode = () => {
                const searchType = document.querySelector('input[name="search-type"]:checked').value;
                searchInputContainer.classList.toggle('hidden', searchType !== 'card');
                setSelectContainer.classList.toggle('hidden', searchType !== 'set');
                searchResultsContainer.innerHTML = '';
                myCollectionContainer.parentElement.classList.toggle('hidden', searchType === 'card' && searchInput.value.trim() !== '');
            };
            
            const searchCards = async () => {
                // ... (Lógica de busca original, sem alterações)
            };

            const displaySearchResults = (cards) => {
                // ... (Lógica de exibição original, sem alterações)
            };

            const createCardElement = (card, groupBy) => {
                const cardElement = document.createElement('div');
                cardElement.className = `collection-card cursor-pointer`;
                cardElement.dataset.id = card.docId;
                const cardPrice = (card.acquiredPrice || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                let pokedexInfo = '';
                if (groupBy === 'pokedex' && card.pokedexNumber) {
                    pokedexInfo = `<p class="font-bold text-lg text-cyan-400 mb-1">#${String(card.pokedexNumber).padStart(3, '0')}</p>`;
                }
                
                const qualityClasses = { 'Nova': 'bg-green-600 text-white', 'Pouco Usada': 'bg-yellow-500 text-gray-900', 'Usada': 'bg-red-600 text-white' };
                const qualityClass = qualityClasses[card.quality] || 'bg-gray-500';

                cardElement.innerHTML = `
                    <div class="card-inner w-full h-full flex flex-col" data-action="details">
                        ${pokedexInfo}
                        <img src="${card.image}" alt="${card.name}" class="rounded-lg mb-2 flex-grow object-cover">
                        <div class="mt-auto text-center">
                            <p class="font-bold text-sm truncate" title="${card.name}">${card.name}</p>
                            <div class="text-xs text-gray-400 flex items-center justify-center gap-1.5 mt-1">
                                <span>${card.set.name}</span> <img src="${card.set.images.symbol}" class="h-4" alt="Set Symbol"> <span>#${String(card.number).padStart(3, '0')}</span>
                            </div>
                            <div class="flex flex-wrap items-center justify-center gap-1 my-2">
                                <div class="text-xs font-semibold px-2 py-0.5 rounded-full ${qualityClass}">${card.quality}</div>
                                <div class="text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-600 text-white">${card.finish}</div>
                            </div>
                            <p class="font-bold text-yellow-400 text-sm">${cardPrice}</p>
                        </div>
                    </div>
                `;
                return cardElement;
            };

            const renderCollection = () => {
                // ... (Lógica de renderização original, sem alterações)
            };
            
            const loadMyCollection = () => {
                // ... (Lógica de carregamento original, sem alterações)
            };

            // --- INICIALIZAÇÃO E EVENT LISTENERS ---
            await Promise.all([fetchExchangeRate(), populateSetDropdown()]);
            toggleSearchMode();
            searchTypeRadios.forEach(radio => radio.addEventListener('change', toggleSearchMode));
            searchButton.addEventListener('click', searchCards);
            
            const firebaseConfig = { /* ...Sua config ... */ };
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                if (collectionUnsubscribe) collectionUnsubscribe();
                collectionPrompt.classList.toggle('hidden', !!user);
                myCollectionContainer.parentElement.classList.toggle('hidden', !user);

                if (user) {
                    currentUserId = user.uid;
                    userEmailDisplay.textContent = user.displayName || user.email;
                    loggedInHeader.classList.remove('hidden');
                    loggedOutHeader.classList.add('hidden');
                    shareCollectionBtn.classList.remove('hidden');
                    loadMyCollection();
                } else {
                    currentUserId = null;
                    loggedInHeader.classList.add('hidden');
                    loggedOutHeader.classList.remove('hidden');
                    shareCollectionBtn.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
