<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Coleção Pokémon TCG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #111827; 
            color: #f3f4f6; 
        }
        /* Aplicando a fonte pixelada para os títulos */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Press Start 2P', cursive;
        }
        .card-item:hover { transform: scale(1.05); }
        /* Loader com cor de destaque amarela */
        .loader { border: 4px solid #4b5563; border-top: 4px solid #f59e0b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content { background-color: #1f2937; padding: 2rem; border-radius: 16px; width: 90%; max-width: 800px; max-height: 85vh; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 1px solid #374151; }
        .group-header {
            grid-column: 1 / -1;
            background-color: #374151;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: bold;
            border-radius: 8px;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        /* Scrollbar para tema escuro */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        
        /* Estilos para o switch do modal de compartilhamento */
        input:checked ~ .dot {
            transform: translateX(100%);
            background-color: #34D399; /* Cor do toggle quando ativo */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- ELEMENTOS DO DOM ---
            const authModal = document.getElementById('auth-modal');
            const authModalCloseBtn = document.getElementById('auth-modal-close-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const googleLoginBtn = document.getElementById('google-login-btn');
            
            const loggedOutHeader = document.getElementById('logged-out-header');
            const loggedInHeader = document.getElementById('logged-in-header');
            const openAuthModalBtn = document.getElementById('open-auth-modal-btn');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutButton = document.getElementById('logout-button');
            
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchResultsContainer = document.getElementById('search-results');
            const myCollectionContainer = document.getElementById('my-collection');
            const loader = document.getElementById('loader');
            const collectionLoader = document.getElementById('collection-loader');
            const collectionCount = document.getElementById('collection-count');
            const uniqueCollectionCount = document.getElementById('unique-collection-count');
            const collectionValue = document.getElementById('collection-value');
            const groupBySelect = document.getElementById('group-by-select');
            const myCollectionSection = document.getElementById('my-collection-section');
            const collectionPrompt = document.getElementById('collection-prompt');

            const addCardModal = document.getElementById('add-card-modal');
            const addCardForm = document.getElementById('add-card-form');
            const addCardModalCloseBtn = document.getElementById('add-card-modal-close-btn');
            const detailsModal = document.getElementById('details-modal');
            const detailsModalCloseBtn = document.getElementById('details-modal-close-btn'); 

            // Elementos do Modal de Compartilhamento
            const shareCollectionBtn = document.getElementById('share-collection-btn');
            const shareModal = document.getElementById('share-modal');
            const shareModalCloseBtn = document.getElementById('share-modal-close-btn');
            const publicToggle = document.getElementById('public-toggle');
            const publicStatusText = document.getElementById('public-status-text');
            const shareableLink = document.getElementById('shareable-link');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const copyFeedback = document.getElementById('copy-feedback');

            let currentUserId = null;
            let searchCache = new Map();
            let collectionData = new Map();
            let collectionUnsubscribe = null;
            let usdToBrlRate = 5.3;
            let db, auth;

            // --- CONTROLO DE VISUALIZAÇÃO ---
            const showView = (viewId) => {
                //... (código existente)
            };

            // --- CÂMBIO ---
            const fetchExchangeRate = async () => {
                //... (código existente)
            };

            // --- LÓGICA DE PESQUISA (API) ---
            const searchCards = async () => {
                //... (código existente)
            };
            const displaySearchResults = (cards) => {
                //... (código existente)
            };
            
            // --- LÓGICA DOS MODAIS ---
            const openAddCardModal = (cardId) => {
                //... (código existente)
            };
            const updatePriceDisplay = () => {
                //... (código existente)
            };
            
            async function handleAddFormSubmit(e) {
                //... (código existente)
            }
            
            const openDetailsModal = (docId) => {
                //... (código existente)
            };

            // --- LÓGICA DA COLEÇÃO (FIRESTORE) ---
            const addCardToCollection = async (cardData) => {
                //... (código existente)
            };
            const handleCollectionClick = async (e) => {
                //... (código existente e simplificado)
            };

            const renderCollection = () => {
                //... (código existente e simplificado)
            };

            const createCardElement = (card, groupBy) => {
                //... (código existente)
            };

            const loadMyCollection = () => {
                //... (código existente)
            };

            // --- LÓGICA DE COMPARTILHAMENTO ---
            const updateShareUI = (isPublic) => {
                publicToggle.checked = isPublic;
                if (isPublic) {
                    publicStatusText.textContent = "Minha coleção é Pública";
                    publicStatusText.classList.remove('text-white');
                    publicStatusText.classList.add('text-green-400');
                    shareableLink.value = `${window.location.origin}${window.location.pathname.replace('index.html', '')}share.html?user=${currentUserId}`;
                    shareableLink.classList.remove('text-gray-600');
                } else {
                    publicStatusText.textContent = "Minha coleção é Privada";
                    publicStatusText.classList.remove('text-green-400');
                    publicStatusText.classList.add('text-white');
                    shareableLink.value = 'Torne sua coleção pública para gerar o link';
                    shareableLink.classList.add('text-gray-600');
                }
            };

            shareCollectionBtn.addEventListener('click', async () => {
                if (!currentUserId) return;
                const profileRef = doc(db, 'public_profiles', currentUserId);
                const profileSnap = await getDoc(profileRef);
                
                let isPublic = false;
                if (profileSnap.exists() && profileSnap.data().isPublic) {
                    isPublic = true;
                }
                updateShareUI(isPublic);
                shareModal.style.display = 'flex';
            });

            publicToggle.addEventListener('change', async () => {
                if (!currentUserId) return;
                const isPublic = publicToggle.checked;
                const profileRef = doc(db, 'public_profiles', currentUserId);
                
                try {
                    await setDoc(profileRef, { 
                        isPublic: isPublic,
                        ownerName: auth.currentUser.displayName || auth.currentUser.email 
                    }, { merge: true });
                    updateShareUI(isPublic);
                } catch (error) {
                    console.error("Erro ao atualizar status público:", error);
                    alert("Não foi possível atualizar o status da sua coleção.");
                }
            });

            copyLinkBtn.addEventListener('click', () => {
                if (!publicToggle.checked) return;
                shareableLink.select();
                document.execCommand('copy');
                copyFeedback.textContent = 'Link copiado!';
                setTimeout(() => { copyFeedback.textContent = '' }, 2000);
            });

            shareModalCloseBtn.addEventListener('click', () => shareModal.style.display = 'none');
            
            // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
            //... (código de inicialização robusta existente)

            onAuthStateChanged(auth, user => {
                if (collectionUnsubscribe) collectionUnsubscribe();
                
                if (user) {
                    currentUserId = user.uid;
                    userEmailDisplay.textContent = user.displayName || user.email;
                    loggedInHeader.classList.remove('hidden');
                    loggedOutHeader.classList.add('hidden');
                    shareCollectionBtn.classList.remove('hidden'); // MOSTRAR BOTÃO
                    loadMyCollection();
                    showView('app-view');
                } else {
                    currentUserId = null;
                    loggedInHeader.classList.add('hidden');
                    loggedOutHeader.classList.remove('hidden');
                    shareCollectionBtn.classList.add('hidden'); // ESCONDER BOTÃO
                    collectionPrompt.classList.remove('hidden');
                    myCollectionContainer.innerHTML = '';
                    collectionCount.textContent = 0;
                    uniqueCollectionCount.textContent = 0;
                    collectionValue.textContent = '0,00';
                    showView('app-view');
                }
            });

            //... (código restante de inicialização e autenticação)
        });

    </script>
    
    <div id="app-view">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex justify-between items-center mb-8 flex-wrap gap-4">
                </header>

            <main class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <section>
                    </section>
                <section id="my-collection-section">
                    <div class="flex justify-between items-center mb-4 border-b-2 border-blue-500 pb-2 flex-wrap gap-4">
                        <h2 class="text-2xl font-bold">Minha Coleção</h2>
                        <div class="text-right" style="font-family: 'Poppins', sans-serif;"><p class="font-bold text-lg text-yellow-400">R$ <span id="collection-value">0,00</span></p><p class="font-semibold text-sm"><span id="collection-count">0</span> Cartas (<span id="unique-collection-count">0</span> Únicas)</p></div>
                    </div>
                    <div id="collection-prompt" class="text-center p-8 bg-gray-800 rounded-lg">
                        <p class="text-gray-400">Faça login para ver e gerir a sua coleção.</p>
                    </div>
                    <div class="flex justify-between items-center mb-4" style="font-family: 'Poppins', sans-serif;">
                        <div>
                            <label for="group-by-select" class="text-sm font-semibold mr-2">Organizar por:</label>
                            <select id="group-by-select" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-sm">
                                <option value="edition">Edição</option>
                                <option value="pokedex">Pokédex</option>
                                <option value="value">Valor</option>
                            </select>
                        </div>
                        <button id="share-collection-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                            Compartilhar
                        </button>
                    </div>
                    <div id="collection-loader" class="loader mx-auto hidden"></div>
                    <div id="my-collection" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[70vh] overflow-y-auto pr-2"></div>
                </section>
            </main>
        </div>
        <footer class="text-center p-6 mt-8 border-t border-gray-700 text-xs" style="font-family: 'Poppins', sans-serif;"><p class="text-sm text-gray-300">Criado com ❤️ por um Mestre Pokémon.</p><p class="text-gray-400 mt-2">Dados de cartas e imagens via <a href="https://pokemontcg.io/" target="_blank" rel="noopener noreferrer" class="underline hover:text-yellow-300">pokemontcg.io</a>.</p><p class="text-gray-500 mt-2">*Os valores em Reais (R$) são estimativas baseadas nos preços de mercado do TCGplayer (USD) e convertidos usando uma taxa de câmbio atualizada diariamente. Os valores servem apenas como referência.</p></footer>
    </div>
    
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; font-family: 'Poppins', sans-serif;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl" style="font-family: 'Press Start 2P', cursive;">Compartilhar Coleção</h2>
                <button id="share-modal-close-btn" class="text-4xl font-bold text-gray-400 hover:text-white">&times;</button>
            </div>
            <p class="text-gray-400 mb-6">Use o link abaixo para compartilhar uma visão pública da sua coleção com outros treinadores!</p>

            <div class="mb-6">
                <label for="public-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="public-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <div id="public-status-text" class="ml-3 text-white font-medium">
                        Minha coleção é Privada
                    </div>
                </label>
            </div>

            <div>
                <label for="shareable-link" class="block text-sm font-medium text-gray-300 mb-1">Seu link público:</label>
                <div class="flex">
                    <input type="text" id="shareable-link" readonly class="w-full bg-gray-800 border border-gray-600 rounded-l-lg px-3 py-2 text-gray-400">
                    <button id="copy-link-btn" class="bg-yellow-500 text-gray-900 font-bold px-4 rounded-r-lg hover:bg-yellow-600">Copiar</button>
                </div>
                <p id="copy-feedback" class="text-green-400 text-sm mt-2 h-4"></p>
            </div>
        </div>
    </div>
</body>
</html>
